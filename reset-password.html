<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Passwort â€“ MusicalKultur App</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.3/dist/umd/supabase.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f7f8fa; color:#333; margin:0; padding:0; }
    .container { max-width:720px; margin:4em auto; padding:2em; background:#fff; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.05);}
    h1 { font-size:2rem; margin-bottom:0.5em; color:#111;}
    p { font-size:1.1rem; line-height:1.6;}
    input,button { display:block; width:100%; margin-top:1em; padding:0.75em; font-size:1rem; border-radius:8px; border:1px solid #ccc;}
    button { background:#0066cc; color:#fff; border:none; cursor:pointer;}
    button[disabled]{opacity:.6;cursor:not-allowed;}
    button:hover:not([disabled]){background:#004d99;}
    .footer { text-align:center; margin-top:3em; font-size:.9rem; color:#777;}
    .success,.error,.info { margin-top:1em; padding:1em; border-radius:8px;}
    .success{background:#e6ffed;color:#2b8a3e;}
    .error{background:#ffe6e6;color:#cc0000;}
    .info{background:#eef6ff;color:#0b69c7;}
  </style>
</head>
<body>
  <div class="container">
    <h1 id="headline">Passwort</h1>
    <p id="subtext"></p>
    <input type="password" id="new-password" placeholder="Neues Passwort" autocomplete="new-password" />
    <input type="password" id="confirm-password" placeholder="Passwort wiederholen" autocomplete="new-password" />
    <button id="btn-reset" onclick="resetPassword()">Passwort speichern</button>
    <div id="message" class="info"></div>
    <div class="footer">Â© 2025 MusicalKultur</div>
  </div>

<script>
  const supabase = window.supabase.createClient(
    'https://tmhfovjxmirdsaqraokv.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtaGZvdmp4bWlyZHNhcXJhb2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM0MjE3ODUsImV4cCI6MjA1ODk5Nzc4NX0.L9wAM6wM5BdRTp_S14Tr8IQ51wEA3nhicWUJ133qASc'
  );

  function qs(sel){return document.querySelector(sel);}
  function setMsg(html,type='info'){const el=qs('#message');el.className=type;el.innerHTML=html;}

  // Fehler ins Deutsche Ã¼bersetzen
  function deAuthError(err){
    const raw=(err?.message||String(err)||'').toLowerCase();
    if(raw.includes('new password should be different')) return 'Das neue Passwort muss sich vom alten unterscheiden.';
    if(raw.includes('expired')||raw.includes('invalid token')) return 'Der Link ist abgelaufen oder ungÃ¼ltig.';
    return 'Fehler: '+(err?.message||'Unbekannter Fehler');
  }

  function validatePassword(pw,pw2){
    if(pw!==pw2) return 'Die PasswÃ¶rter stimmen nicht Ã¼berein.';
    if(pw.length<8) return 'Das Passwort muss mindestens 8 Zeichen lang sein.';
    if(!/[A-Z]/.test(pw)) return 'Das Passwort muss mindestens einen GroÃŸbuchstaben enthalten.';
    if(!/[0-9]/.test(pw)) return 'Das Passwort muss mindestens eine Zahl enthalten.';
    return null;
  }

  async function ensureSessionFromUrl(){
    const url=new URL(location.href);
    const q=url.searchParams;
    const token_hash=q.get('token_hash');
    const type=q.get('type');
    if(token_hash&&(type==='recovery'||type==='invite')){
      const {data,error}=await supabase.auth.verifyOtp({type:'recovery',token_hash});
      if(error) throw new Error(error.message||'Verifizierung fehlgeschlagen.');
      return {session:data.session,type};
    }
    return {session:null,type:null};
  }

  async function resetPassword(){
    const btn=qs('#btn-reset');
    const pw=qs('#new-password').value.trim();
    const pw2=qs('#confirm-password').value.trim();
    setMsg('');
    const v=validatePassword(pw,pw2);
    if(v){setMsg(v,'error');return;}
    btn.disabled=true;btn.textContent='Speichernâ€¦';
    try{
      const {session,type}=await ensureSessionFromUrl();
      if(!session){setMsg('Kein gÃ¼ltiger Link. Bitte Ã¶ffne die E-Mail erneut.','error');return;}
      const {error}=await supabase.auth.updateUser({password:pw});
      if(error){setMsg(deAuthError(error),'error');return;}
      if(type==='invite'){
        setMsg('âœ… Willkommen! Dein Passwort wurde gesetzt. Du kannst dich jetzt anmelden.','success');
      } else {
        setMsg('âœ… Passwort erfolgreich geÃ¤ndert. Du kannst dich jetzt mit dem neuen Passwort anmelden.','success');
      }
    }catch(err){setMsg(deAuthError(err),'error');}
    finally{btn.disabled=false;btn.textContent='Passwort speichern';}
  }

  // Texte je nach Typ setzen
  (function initTexts(){
    const url=new URL(location.href);
    const type=url.searchParams.get('type');
    const headline=qs('#headline');
    const sub=qs('#subtext');
    if(type==='invite'){
      headline.textContent='Herzlich willkommen ðŸŽ‰';
      sub.textContent='Bitte lege dein persÃ¶nliches Passwort fest, um dein Konto zu aktivieren:';
      qs('#btn-reset').textContent='Passwort festlegen';
      qs('#message').textContent='Tipp: Der Link ist nur kurze Zeit gÃ¼ltig.';
    }else{
      headline.textContent='Passwort zurÃ¼cksetzen';
      sub.textContent='Bitte gib dein neues Passwort ein:';
      qs('#btn-reset').textContent='Passwort Ã¤ndern';
      qs('#message').textContent='Tipp: Der Link ist nur kurze Zeit gÃ¼ltig. Falls etwas nicht klappt, fordere einen neuen Link an.';
    }
  })();
</script>
</body>
</html>
